<!DOCTYPE html>
<html>
  <head>
    <title>A-Frame / WebXR / AR / Hit Test</title>
    <meta name="description" content="Hello, WebVR! - A-Frame">
    <script src='./aframe-master.js'></script>
    <script src='./three.xr.js'></script>
    <script src='./aframe-xr.js'></script>
    <script src='./hit-test.js'></script>
    <!-- Add MediaPipe dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  </head>
  <body>
    <!-- Tambahkan elemen video untuk MediaPipe -->
    <video id="input-video" style="display: none;"></video>
    
    <a-scene hit-test>
      <a-assets timeout="10000">
        <a-asset-item id="yogaspa" src="./yogaspa.glb"></a-asset-item>
      </a-assets>
    </a-scene>

    <script>
      var scene = AFRAME.scenes[0];

      // Handle asset loading errors
      var modelAsset = document.querySelector('#yogaspa');
      modelAsset.addEventListener('error', function(e) {
        console.error('Error loading model:', e);
        // Fallback to a basic shape if model fails to load
        createFallbackObject();
      });

      var newObject = function(data) {
        var entity = data.detail;

        entity.setAttribute('gltf-model', '#yogaspa');
        entity.setAttribute('scale', '0.1 0.1 0.1');
        entity.setAttribute('material', {
          shader: 'standard',
          fog: false
        });     
        
        // Add class for hand interaction
        entity.setAttribute('class', 'interactive');
        entity.setAttribute('position', '0 0 0');

        scene.appendChild(entity);
        
        // Store reference to manipulate later
        window.yogaspaEntity = entity;
      }

      // Initialize MediaPipe Hands
      const hands = new Hands({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
      }});

      hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });

      hands.onResults(results => {
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
          const hand = results.multiHandLandmarks[0];
          
          // Get index finger tip position (landmark 8)
          const indexTip = hand[8];
          
          if (window.yogaspaEntity) {
            // Map hand position to object manipulation
            // Scale based on distance between thumb and index finger
            const thumbTip = hand[4];
            const distance = Math.sqrt(
              Math.pow(thumbTip.x - indexTip.x, 2) +
              Math.pow(thumbTip.y - indexTip.y, 2)
            );
            
            // Update object position based on hand movement
            window.yogaspaEntity.setAttribute('position', {
              x: (indexTip.x - 0.5) * 2,
              y: (-indexTip.y + 0.5) * 2,
              z: -distance * 2
            });
          }
        }
      });

      // Start camera feed for hand tracking
      // Perbaiki inisialisasi kamera
      const camera = new Camera(document.querySelector('#input-video'), {
          onFrame: async () => {
              await hands.send({image: document.querySelector('#input-video')});
          },
          width: 1280,
          height: 720
      });
      camera.start();

      function createFallbackObject(data) {
        var entity = data.detail;
        entity.setAttribute('geometry', {
          primitive: 'box',
          width: 0.1,
          height: 0.1,
          depth: 0.1
        });
        entity.setAttribute('material', {
          color: 'red'
        });
        scene.appendChild(entity);
      }

      scene.addEventListener('newAnchoredEntity', newObject);
    </script>
  </body>
</html>


